#!/bin/bash
set -e

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ   ะะะะะะะกะะซะ ะะะะะะ FRONTEND         โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ะัะพะฒะตัะบะฐ ััะพ ะทะฐะฟััะตะฝ ะฝะฐ production ัะตัะฒะตัะต
if [ ! -d "/root/Labosfera" ]; then
    echo "โ ะัะธะฑะบะฐ: ะทะฐะฟััะบะฐะนัะต ะฝะฐ production ัะตัะฒะตัะต!"
    exit 1
fi

cd /root/Labosfera

# 1. ะกะบะฐัะฐัั ัะฒะตะถะธะน ะบะพะด
echo "๐ฅ ะกะบะฐัะธะฒะฐะฝะธะต ะพะฑะฝะพะฒะปะตะฝะธะน ั GitHub..."
git pull origin main
if [ $? -ne 0 ]; then
    echo "โ ะัะธะฑะบะฐ git pull"
    exit 1
fi
echo "โ ะะพะด ะพะฑะฝะพะฒะปะตะฝ"
echo ""

# 2. ะะตัะตัะพะฑัะฐัั frontend ะพะฑัะฐะท
echo "๐จ ะะตัะตัะฑะพัะบะฐ frontend Docker ะพะฑัะฐะทะฐ..."
docker-compose -f docker-compose.prod.yml build frontend
if [ $? -ne 0 ]; then
    echo "โ ะัะธะฑะบะฐ ัะฑะพัะบะธ"
    exit 1
fi
echo "โ ะะฑัะฐะท ัะพะฑัะฐะฝ"
echo ""

# 3. ะััะฐะฝะพะฒะธัั ะธ ัะดะฐะปะธัั ััะฐััะน frontend
echo "โธ๏ธ  ะััะฐะฝะพะฒะบะฐ ััะฐัะพะณะพ frontend ะบะพะฝัะตะนะฝะตัะฐ..."
docker-compose -f docker-compose.prod.yml stop frontend
docker-compose -f docker-compose.prod.yml rm -f frontend
echo "โ ะกัะฐััะน ะบะพะฝัะตะนะฝะตั ัะดะฐะปะตะฝ"
echo ""

# 4. ะะฐะฟัััะธัั ะฝะพะฒัะน frontend (ะะะ ะฟะตัะตัะพะทะดะฐะฝะธั ะทะฐะฒะธัะธะผะพััะตะน!)
echo "๐ ะะฐะฟััะบ ะฝะพะฒะพะณะพ frontend ะบะพะฝัะตะนะฝะตัะฐ..."
docker-compose -f docker-compose.prod.yml up -d --no-deps frontend
echo "โ ะะพะฒัะน ะบะพะฝัะตะนะฝะตั ะทะฐะฟััะตะฝ"
echo ""

# 5. ะะพะดะพะถะดะฐัั ะฟะพะบะฐ frontend ะทะฐะฟัััะธััั
echo "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ frontend (15 ัะตะบัะฝะด)..."
sleep 15

# 6. ะัะพะฒะตัะธัั ััะพ frontend ัะฐะฑะพัะฐะตั ะฒะฝัััะธ ะบะพะฝัะตะนะฝะตัะฐ
echo "๐ ะัะพะฒะตัะบะฐ ัะฐะฑะพัั frontend..."
if docker exec labosfera_frontend_1 wget --quiet --tries=1 --spider http://localhost:3000 2>/dev/null; then
    echo "โ Frontend ะพัะฒะตัะฐะตั ะฒะฝัััะธ ะบะพะฝัะตะนะฝะตัะฐ"
else
    echo "โ๏ธ Frontend ะฝะต ะพัะฒะตัะฐะตั, ะฟะพะบะฐะทัะฒะฐั ะปะพะณะธ:"
    docker logs labosfera_frontend_1 --tail 50
    echo ""
    echo "โ ะะตะฟะปะพะน ะผะพะถะตั ะฑััั ะฝะตััะฟะตัะฝัะผ, ะฟัะพะฒะตัััะต ะปะพะณะธ ะฒััะต"
fi
echo ""

# 7. ะะตัะตะทะฐะณััะทะธัั Nginx ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั DNS ะบััะฐ
echo "๐ ะะตัะตะทะฐะณััะทะบะฐ Nginx ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั ะผะฐัััััะธะทะฐัะธะธ..."
docker-compose -f docker-compose.prod.yml restart nginx
sleep 5
echo "โ Nginx ะฟะตัะตะทะฐะณััะถะตะฝ"
echo ""

# 8. ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ ัะตัะตะท Nginx
echo "๐ ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ ัะฐะนัะฐ ัะตัะตะท Nginx..."
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://labosfera.ru)
if [ "$HTTP_CODE" = "200" ]; then
    echo "โ ะกะฐะนั ะดะพัััะฟะตะฝ! (HTTP $HTTP_CODE)"
else
    echo "โ ะกะฐะนั ะฒะตัะฝัะป HTTP $HTTP_CODE"
    echo "ะะพะณะธ Nginx:"
    docker logs labosfera_nginx_1 --tail 20
    exit 1
fi
echo ""

# 9. ะะพะบะฐะทะฐัั ััะฐััั ะฒัะตั ะบะพะฝัะตะนะฝะตัะพะฒ
echo "๐ ะกัะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ:"
docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Image}}'
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ    ๐ ะะะะะะ ะะะะะะจะะ ะฃะกะะะจะะ!       โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ ะัะพะฒะตัััะต ัะฐะนั: https://labosfera.ru"
echo "๐ ะะพะณะธ: docker logs labosfera_frontend_1 -f"
