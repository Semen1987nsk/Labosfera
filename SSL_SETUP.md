# üîê SSL –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è Labosfera

## ‚úÖ –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã!

–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: `/workspaces/Labosfera/nginx/ssl/`

### –§–∞–π–ª—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:

```
nginx/ssl/
‚îú‚îÄ‚îÄ fullchain.crt              # –ü–æ–ª–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π + –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ)
‚îú‚îÄ‚îÄ labosfera.ru.crt           # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–æ–º–µ–Ω–∞
‚îú‚îÄ‚îÄ labosfera.ru.key           # –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (–°–ï–ö–†–ï–¢–ù–´–ô!)
‚îî‚îÄ‚îÄ labosfera.ru.chain.crt     # –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
```

## üöÄ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –í–∞—Ä–∏–∞–Ω—Ç 1: docker-compose.prod.yml (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

**–ü—Ä–∏ —Å–±–æ—Ä–∫–µ nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:**
1. Dockerfile –∫–æ–ø–∏—Ä—É–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã –∏–∑ `nginx/ssl/` –≤ `/etc/nginx/ssl/` –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è `nginx/prod.conf` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã:
   ```nginx
   ssl_certificate /etc/nginx/ssl/fullchain.crt;
   ssl_certificate_key /etc/nginx/ssl/labosfera.ru.key;
   ```
3. Nginx —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç—ã 80 (HTTP) –∏ 443 (HTTPS)
4. HTTP –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ HTTPS

**–ö–æ–º–∞–Ω–¥—ã:**
```bash
# –ó–∞–ø—É—Å–∫ —Å SSL
docker-compose -f docker-compose.prod.yml up -d --build

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL –≤ –ª–æ–≥–∞—Ö
docker-compose -f docker-compose.prod.yml logs nginx

# –¢–µ—Å—Ç HTTPS
curl -I https://labosfera.ru
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: docker-compose.simple.yml (–ë–ï–ó SSL)

**–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:**
- Nginx —Å–ª—É—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Ä—Ç 80 (HTTP)
- SSL –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤–Ω–µ—à–Ω–∏–º –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å Timeweb)
- –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ù–ï –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ Docker

## üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

### –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
openssl x509 -in nginx/ssl/labosfera.ru.crt -noout -dates

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–ª—è –∫–æ–≥–æ –≤—ã–¥–∞–Ω
openssl x509 -in nginx/ssl/labosfera.ru.crt -noout -subject

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ø–æ—á–∫—É
openssl x509 -in nginx/ssl/fullchain.crt -noout -text
```

### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker exec labosfera_nginx ls -la /etc/nginx/ssl/

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx
docker exec labosfera_nginx nginx -t

# –¢–µ—Å—Ç SSL —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
openssl s_client -connect labosfera.ru:443 -servername labosfera.ru
```

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

–ï—Å–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏—Å—Ç–µ–∫–∞—é—Ç, –Ω—É–∂–Ω–æ:

### 1. –û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª—ã –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ

–ó–∞–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª—ã –≤ `nginx/ssl/`:
```bash
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
cp /–ø—É—Ç—å/–∫/–Ω–æ–≤—ã–º/fullchain.crt nginx/ssl/
cp /–ø—É—Ç—å/–∫/–Ω–æ–≤—ã–º/labosfera.ru.key nginx/ssl/
```

### 2. –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –≤ Git (–µ—Å–ª–∏ –∫–ª—é—á –Ω–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π) –∏–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä

```bash
# –í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ Git (–ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π)
git add nginx/ssl/
git commit -m "Update SSL certificates"
git push

# –í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ SCP (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)
scp nginx/ssl/* root@–í–ê–®_IP:/opt/Labosfera/nginx/ssl/
```

### 3. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```bash
ssh root@–í–ê–®_IP
cd /opt/Labosfera

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å nginx
docker-compose -f docker-compose.prod.yml up -d --build --force-recreate nginx
```

## ‚ö†Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –í–∞–∂–Ω–æ:

1. **–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á** (`labosfera.ru.key`) - **–°–ï–ö–†–ï–¢–ù–´–ô!**
   - –ù–ï –∫–æ–º–º–∏—Ç—å—Ç–µ –≤ –ø—É–±–ª–∏—á–Ω—ã–π Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
   - –•—Ä–∞–Ω–∏—Ç–µ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.gitignore` –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è

2. **–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:**
   ```bash
   # –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞
   chmod 600 /opt/Labosfera/nginx/ssl/labosfera.ru.key
   chmod 644 /opt/Labosfera/nginx/ssl/*.crt
   ```

3. **Backup:**
   - –°–¥–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ `nginx/ssl/`
   - –•—Ä–∞–Ω–∏—Ç–µ –≤ –Ω–∞–¥–µ–∂–Ω–æ–º –º–µ—Å—Ç–µ (–Ω–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL –Ω–∞ —Ä–∞–±–æ—Ç–∞—é—â–µ–º —Å–∞–π—Ç–µ

### –û–Ω–ª–∞–π–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:

1. **SSL Labs Test:**
   https://www.ssllabs.com/ssltest/analyze.html?d=labosfera.ru

2. **SSL Checker:**
   https://www.sslshopper.com/ssl-checker.html

### –ö–æ–º–∞–Ω–¥—ã:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SSL —Å —Å–µ—Ä–≤–µ—Ä–∞
curl -vI https://labosfera.ru 2>&1 | grep -i ssl

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å HTTP –Ω–∞ HTTPS
curl -I http://labosfera.ru

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
echo | openssl s_client -connect labosfera.ru:443 2>/dev/null | openssl x509 -noout -dates
```

## üÜò –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞: "SSL certificate problem"

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ fullchain.crt —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é —Ü–µ–ø–æ—á–∫—É
openssl crl2pkcs7 -nocrl -certfile nginx/ssl/fullchain.crt | openssl pkcs7 -print_certs -noout
```

### –û—à–∏–±–∫–∞: "nginx: [emerg] cannot load certificate"

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–æ–≤
file nginx/ssl/fullchain.crt
file nginx/ssl/labosfera.ru.key

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–ª—é—á –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–æ–≤–ø–∞–¥–∞—é—Ç
openssl x509 -noout -modulus -in nginx/ssl/labosfera.ru.crt | openssl md5
openssl rsa -noout -modulus -in nginx/ssl/labosfera.ru.key | openssl md5
```

### –ë—Ä–∞—É–∑–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "Certificate is not trusted"

- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ `fullchain.crt`, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ `labosfera.ru.crt`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

## ‚úÖ –ò—Ç–æ–≥–æ

- ‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É–∂–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ —Å–±–æ—Ä–∫–µ
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ nginx/prod.conf
- ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç —Å docker-compose.prod.yml
- ‚úÖ HTTPS –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

**–ü—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `docker-compose.prod.yml` –∏ SSL –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!** üéâ
