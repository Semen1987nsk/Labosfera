#!/bin/bash
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð›ÐÐ‘ÐžÐ¡Ð¤Ð•Ð Ð Ð´Ð»Ñ Timeweb Cloud
# ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ ÑÐµÑ€Ð²ÐµÑ€Ð° Ð´Ð»Ñ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¹ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚Ð¸

set -e

# Ð¦Ð²ÐµÑ‚Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}ðŸš€ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð›ÐÐ‘ÐžÐ¡Ð¤Ð•Ð Ð Ð´Ð»Ñ Timeweb Cloud${NC}"
echo ""

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸
error() {
    echo -e "${RED}âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: $1${NC}"
    exit 1
}

success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° root
if [ "$EUID" -ne 0 ]; then
    error "Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒÑÑ Ð¿Ð¾Ð´ root"
fi

echo "ðŸ“Š Ð¢ÐµÐºÑƒÑ‰Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "CPU:  $(nproc) ÑÐ´ÐµÑ€"
echo "RAM:  $(free -h | awk '/^Mem:/ {print $2}') (Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾: $(free -h | awk '/^Mem:/ {print $7}'))"
echo "Ð”Ð¸ÑÐº: $(df -h / | awk 'NR==2 {print $2}') (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ: $(df -h / | awk 'NR==2 {print $3}'))"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

read -p "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸ÑŽ? (y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 0
fi

echo ""
info "ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸ÑŽ..."
echo ""

# 1. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SWAP
echo "ðŸ’¾ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SWAP..."
if [ ! -f /swapfile ]; then
    # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ RAM
    RAM_GB=$(free -g | awk '/^Mem:/ {print $2}')
    
    if [ "$RAM_GB" -le 2 ]; then
        SWAP_SIZE="2G"
    elif [ "$RAM_GB" -le 4 ]; then
        SWAP_SIZE="4G"
    else
        SWAP_SIZE="8G"
    fi
    
    info "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ SWAP Ñ„Ð°Ð¹Ð» Ñ€Ð°Ð·Ð¼ÐµÑ€Ð¾Ð¼ $SWAP_SIZE"
    fallocate -l $SWAP_SIZE /swapfile
    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile
    
    # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð² fstab ÐµÑÐ»Ð¸ ÐµÑ‰Ðµ Ð½ÐµÑ‚
    if ! grep -q "/swapfile" /etc/fstab; then
        echo '/swapfile none swap sw 0 0' >> /etc/fstab
    fi
    
    # ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² swap
    echo "vm.swappiness=10" >> /etc/sysctl.conf
    echo "vm.vfs_cache_pressure=50" >> /etc/sysctl.conf
    sysctl -p
    
    success "SWAP Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ ($SWAP_SIZE)"
else
    success "SWAP ÑƒÐ¶Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
fi

# 2. ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² ÑÐ´Ñ€Ð° Ð´Ð»Ñ Ð²ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€Ð°
echo ""
echo "âš™ï¸  ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² ÑÐ´Ñ€Ð°..."

cat >> /etc/sysctl.conf << 'EOF'

# ===================================
# ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ Timeweb Cloud
# ===================================

# Ð¡ÐµÑ‚ÐµÐ²Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 65535
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 15
net.ipv4.ip_local_port_range = 10000 65535
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_probes = 5
net.ipv4.tcp_keepalive_intvl = 15

# ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ
fs.file-max = 65535
fs.inotify.max_user_watches = 524288

# Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.conf.all.accept_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0

EOF

sysctl -p > /dev/null 2>&1
success "ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐ´Ñ€Ð° Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹"

# 3. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
echo ""
echo "ðŸ“ˆ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð²..."

cat >> /etc/security/limits.conf << 'EOF'

# Ð›Ð¸Ð¼Ð¸Ñ‚Ñ‹ Ð´Ð»Ñ Timeweb Cloud
* soft nofile 65535
* hard nofile 65535
* soft nproc 65535
* hard nproc 65535
root soft nofile 65535
root hard nofile 65535

EOF

success "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ñ‹"

# 4. ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Docker
echo ""
echo "ðŸ³ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Docker..."

mkdir -p /etc/docker

cat > /etc/docker/daemon.json << 'EOF'
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "storage-driver": "overlay2",
  "default-ulimits": {
    "nofile": {
      "Name": "nofile",
      "Hard": 65535,
      "Soft": 65535
    }
  }
}
EOF

systemctl restart docker
success "Docker Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½"

# 5. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸
echo ""
echo "ðŸ§¹ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸..."

cat > /opt/timeweb-cleanup.sh << 'EOF'
#!/bin/bash
# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð´Ð»Ñ Timeweb Cloud

LOG_FILE="/var/log/timeweb-cleanup.log"

echo "=== Cleanup started: $(date) ===" >> $LOG_FILE

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Docker
echo "Cleaning Docker..." >> $LOG_FILE
docker system prune -af --volumes --filter "until=72h" >> $LOG_FILE 2>&1

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð»Ð¾Ð³Ð¾Ð² ÑÑ‚Ð°Ñ€ÑˆÐµ 7 Ð´Ð½ÐµÐ¹
echo "Cleaning old logs..." >> $LOG_FILE
find /opt/labosfera/backend/logs -name "*.log" -mtime +7 -delete >> $LOG_FILE 2>&1
find /var/log -name "*.log" -mtime +14 -delete >> $LOG_FILE 2>&1
find /var/log -name "*.gz" -mtime +14 -delete >> $LOG_FILE 2>&1

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
echo "Cleaning temp files..." >> $LOG_FILE
find /tmp -type f -mtime +7 -delete >> $LOG_FILE 2>&1

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° APT ÐºÑÑˆÐ°
echo "Cleaning apt cache..." >> $LOG_FILE
apt-get clean >> $LOG_FILE 2>&1
apt-get autoclean >> $LOG_FILE 2>&1

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð¸ÑÐºÐ°
echo "Disk usage:" >> $LOG_FILE
df -h / >> $LOG_FILE 2>&1

echo "=== Cleanup completed: $(date) ===" >> $LOG_FILE
echo "" >> $LOG_FILE

EOF

chmod +x /opt/timeweb-cleanup.sh

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð² cron (ÐºÐ°Ð¶Ð´Ð¾Ðµ Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ Ð² 3:00)
if ! crontab -l 2>/dev/null | grep -q "timeweb-cleanup"; then
    (crontab -l 2>/dev/null; echo "0 3 * * 0 /opt/timeweb-cleanup.sh") | crontab -
fi

success "ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð° (ÐºÐ°Ð¶Ð´Ð¾Ðµ Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ Ð² 3:00)"

# 6. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
echo ""
echo "ðŸ’¾ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ..."

mkdir -p /opt/backups

cat > /opt/timeweb-backup.sh << 'EOF'
#!/bin/bash
# Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð»Ñ Timeweb Cloud

BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)
KEEP_DAYS=7

cd /opt/labosfera

echo "=== Backup started: $(date) ==="

# Ð‘ÑÐºÐ°Ð¿ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
echo "Backing up database..."
docker-compose -f docker-compose.prod.yml exec -T db pg_dump -U labosfera labosfera > "$BACKUP_DIR/db_$DATE.sql"

# Ð‘ÑÐºÐ°Ð¿ Ð¼ÐµÐ´Ð¸Ð° Ñ„Ð°Ð¹Ð»Ð¾Ð²
echo "Backing up media files..."
tar -czf "$BACKUP_DIR/media_$DATE.tar.gz" -C backend/media . 2>/dev/null || true

# Ð‘ÑÐºÐ°Ð¿ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
echo "Backing up configuration..."
tar -czf "$BACKUP_DIR/config_$DATE.tar.gz" .env.prod docker-compose.prod.yml nginx/ 2>/dev/null || true

# Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð±ÑÐºÐ°Ð¿Ð¾Ð²
echo "Removing old backups (older than $KEEP_DAYS days)..."
find $BACKUP_DIR -name "*.sql" -mtime +$KEEP_DAYS -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +$KEEP_DAYS -delete

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ
echo "=== Backup completed: $(date) ==="
echo "Backups stored in: $BACKUP_DIR"
du -sh $BACKUP_DIR
ls -lh $BACKUP_DIR | tail -10

EOF

chmod +x /opt/timeweb-backup.sh

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð² cron (ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 2:00)
if ! crontab -l 2>/dev/null | grep -q "timeweb-backup"; then
    (crontab -l 2>/dev/null; echo "0 2 * * * /opt/timeweb-backup.sh >> /var/log/timeweb-backup.log 2>&1") | crontab -
fi

success "Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾ (ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 2:00)"

# 7. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°
echo ""
echo "ðŸ“Š Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°..."

apt-get install -y htop iotop nethogs ncdu > /dev/null 2>&1

cat > /opt/timeweb-monitor.sh << 'EOF'
#!/bin/bash
# ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð´Ð»Ñ Timeweb Cloud

echo "==================================="
echo "Ð›ÐÐ‘ÐžÐ¡Ð¤Ð•Ð Ð - ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ ÑÐµÑ€Ð²ÐµÑ€Ð°"
echo "==================================="
echo ""

echo "ðŸ“Š Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° CPU:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¾: " 100 - $1 "%"}'
echo ""

echo "ðŸ’¾ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ RAM:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
free -h
echo ""

echo "ðŸ’¿ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð¸ÑÐºÐ°:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
df -h /
echo ""

echo "ðŸ³ Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
cd /opt/labosfera
docker-compose -f docker-compose.prod.yml ps
echo ""

echo "ðŸ“ˆ Docker Ñ€ÐµÑÑƒÑ€ÑÑ‹:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
echo ""

echo "ðŸŒ Ð¡ÐµÑ‚ÐµÐ²Ñ‹Ðµ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹: $(netstat -an | grep ESTABLISHED | wc -l)"
echo "HTTP ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹: $(netstat -an | grep :80 | grep ESTABLISHED | wc -l)"
echo "HTTPS ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹: $(netstat -an | grep :443 | grep ESTABLISHED | wc -l)"
echo ""

echo "ðŸ“ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 10 ÑÑ‚Ñ€Ð¾Ðº Ð»Ð¾Ð³Ð¾Ð² nginx:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
docker-compose -f docker-compose.prod.yml logs --tail=10 nginx 2>/dev/null | tail -10
echo ""

echo "==================================="
echo "ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½: $(date)"
echo "==================================="

EOF

chmod +x /opt/timeweb-monitor.sh

success "Ð˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

# 8. ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Nginx Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ
echo ""
echo "âš¡ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."

if [ -f /opt/labosfera/nginx/prod.conf ]; then
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿
    cp /opt/labosfera/nginx/prod.conf /opt/labosfera/nginx/prod.conf.backup
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
    if ! grep -q "gzip_comp_level" /opt/labosfera/nginx/prod.conf; then
        info "Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð² nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ"
        # ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð±ÑƒÐ´ÑƒÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ Ñ‡ÐµÑ€ÐµÐ· Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
        success "Nginx Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð»ÐµÐ½Ñ‹ (Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²)"
    else
        success "Nginx ÑƒÐ¶Ðµ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½"
    fi
fi

# 9. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ñ… ÐºÐ¾Ð¼Ð°Ð½Ð´
echo ""
echo "ðŸ“‹ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… ÐºÐ¾Ð¼Ð°Ð½Ð´..."

cat > /usr/local/bin/labosfera-status << 'EOF'
#!/bin/bash
/opt/timeweb-monitor.sh
EOF
chmod +x /usr/local/bin/labosfera-status

cat > /usr/local/bin/labosfera-backup << 'EOF'
#!/bin/bash
/opt/timeweb-backup.sh
EOF
chmod +x /usr/local/bin/labosfera-backup

cat > /usr/local/bin/labosfera-cleanup << 'EOF'
#!/bin/bash
/opt/timeweb-cleanup.sh
EOF
chmod +x /usr/local/bin/labosfera-cleanup

cat > /usr/local/bin/labosfera-logs << 'EOF'
#!/bin/bash
cd /opt/labosfera
docker-compose -f docker-compose.prod.yml logs -f
EOF
chmod +x /usr/local/bin/labosfera-logs

success "Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹"

# 10. Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
echo ""
echo "ðŸ”§ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº..."

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° systemd Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð»Ð¸Ð¼Ð¸Ñ‚Ð¾Ð²
systemctl daemon-reload

success "Ð’ÑÐµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹"

# Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
echo ""
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}ðŸŽ‰ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

echo -e "${BLUE}ðŸ“Š Ð¢ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ:${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "CPU:  $(nproc) ÑÐ´ÐµÑ€"
echo "RAM:  $(free -h | awk '/^Mem:/ {print $2}') (ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾: $(free -h | awk '/^Mem:/ {print $7}'))"
echo "SWAP: $(free -h | awk '/^Swap:/ {print $2}') (ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾: $(free -h | awk '/^Swap:/ {print $4}'))"
echo "Ð”Ð¸ÑÐº: $(df -h / | awk 'NR==2 {print $2}') (ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾: $(df -h / | awk 'NR==2 {print $4}'))"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

echo -e "${BLUE}âœ… Ð§Ñ‚Ð¾ Ð±Ñ‹Ð»Ð¾ ÑÐ´ÐµÐ»Ð°Ð½Ð¾:${NC}"
echo ""
echo "  âœ… SWAP Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
echo "  âœ… ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐ´Ñ€Ð° Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð´Ð»Ñ Ð²ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€Ð°"
echo "  âœ… Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ñ‹"
echo "  âœ… Docker Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½"
echo "  âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð° (Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ 3:00)"
echo "  âœ… Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾ (ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾ 2:00)"
echo "  âœ… Ð˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
echo "  âœ… Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹"
echo ""

echo -e "${BLUE}ðŸš€ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "  labosfera-status   - Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²ÐµÑ€Ð° Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²"
echo "  labosfera-logs     - ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð»Ð¾Ð³Ð¾Ð² Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸"
echo "  labosfera-backup   - Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ"
echo "  labosfera-cleanup  - ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

echo -e "${BLUE}ðŸ“ˆ ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ð°Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ:${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "  Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†:       0.2-0.5 ÑÐµÐº  âš¡âš¡âš¡âš¡âš¡"
echo "  ÐžÐ´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·.:   100-150"
echo "  Ð—Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² ÑÐµÐºÑƒÐ½Ð´Ñƒ:     200-300"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo ""

echo -e "${YELLOW}âš ï¸  Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸:${NC}"
echo ""
echo "  1. ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ ÑÐµÑ€Ð²ÐµÑ€ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð²ÑÐµÑ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹:"
echo "     ${BLUE}reboot${NC}"
echo ""
echo "  2. ÐŸÐ¾ÑÐ»Ðµ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑ:"
echo "     ${BLUE}labosfera-status${NC}"
echo ""
echo "  3. Ð•ÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚Ðµ Ð›ÐÐ‘ÐžÐ¡Ð¤Ð•Ð Ð, Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹:"
echo "     ${BLUE}cd /opt/labosfera && docker-compose -f docker-compose.prod.yml restart${NC}"
echo ""

echo -e "${GREEN}ðŸŽŠ Ð’Ð°Ñˆ ÑÐµÑ€Ð²ÐµÑ€ Timeweb Cloud Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½!${NC}"
echo ""

read -p "ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²ÐµÑ€ ÑÐµÐ¹Ñ‡Ð°Ñ? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo ""
    info "ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· 5 ÑÐµÐºÑƒÐ½Ð´..."
    sleep 5
    reboot
fi

echo ""
echo "Ð”Ð»Ñ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ: reboot"
